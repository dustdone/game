# 🌐 外网访问配置指南

## 📋 概述

本指南将帮助你配置服务器，使其能够通过外网IP地址访问。

## 🔧 配置步骤

### 1. 修改环境变量

在 `.env` 文件中添加以下配置：

```bash
# 服务器配置
HOST=0.0.0.0          # 监听所有网络接口
PORT=5555              # 服务器端口
NODE_ENV=production    # 生产环境

# 跨域配置
CORS_ORIGIN=*          # 允许所有来源访问

# 安全配置
ALLOWED_IPS=           # 允许访问的IP列表（可选）
BLOCK_PRIVATE_IPS=false # 是否阻止私有IP访问
```

### 2. 防火墙配置

#### macOS (系统偏好设置)
1. 打开"系统偏好设置" → "安全性与隐私" → "防火墙"
2. 点击"防火墙选项"
3. 添加应用程序：选择你的Node.js应用
4. 确保端口5555被允许

#### 命令行配置
```bash
# 允许端口5555的入站连接
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/local/bin/node
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblock /usr/local/bin/node

# 或者使用pfctl (如果启用了pf防火墙)
echo "pass in proto tcp from any to any port 5555" | sudo pfctl -ef -
```

### 3. 路由器配置

#### 端口转发设置
1. 登录路由器管理界面
2. 找到"端口转发"或"Port Forwarding"
3. 添加新规则：
   - 外部端口：5555
   - 内部端口：5555
   - 内部IP：你的电脑局域网IP
   - 协议：TCP

#### 获取公网IP
1. 访问 `https://www.whatismyip.com` 查看公网IP
2. 或者使用命令行：
   ```bash
   curl ifconfig.me
   curl ipinfo.io/ip
   ```

### 4. 网络测试

#### 本地测试
```bash
# 测试本地访问
curl http://localhost:5555/health

# 测试局域网访问
curl http://你的局域网IP:5555/health
```

#### 外网测试
```bash
# 测试公网访问
curl http://你的公网IP:5555/health

# 或者从其他网络测试
curl http://你的公网IP:5555/health
```

## 🌍 访问地址

配置完成后，你可以通过以下地址访问：

- **本地访问**: `http://localhost:5555`
- **局域网访问**: `http://你的局域网IP:5555`
- **外网访问**: `http://你的公网IP:5555`

## 🔒 安全注意事项

### 1. 生产环境安全
- 使用HTTPS（SSL/TLS）
- 设置强密码和JWT密钥
- 启用速率限制
- 配置IP白名单

### 2. 网络安全
- 定期更新系统和依赖
- 监控访问日志
- 使用防火墙规则
- 考虑使用CDN服务

### 3. 数据库安全
- 不要暴露数据库端口到外网
- 使用强密码
- 限制数据库用户权限
- 定期备份数据

## 🚀 启动服务器

```bash
# 开发环境
npm run dev

# 生产环境
npm start

# 或者直接运行
node server.js
```

## 📊 监控和日志

### 健康检查
访问 `/health` 端点查看服务器状态：
```bash
curl http://localhost:5555/health
```

### 查看日志
```bash
# 实时查看日志
tail -f logs/server.log

# 查看错误日志
grep "ERROR" logs/server.log
```

## ❗ 常见问题

### 1. 无法外网访问
- 检查防火墙设置
- 确认端口转发配置
- 验证公网IP是否正确
- 检查ISP是否阻止端口

### 2. 连接超时
- 检查服务器是否正常运行
- 确认端口是否开放
- 验证网络配置

### 3. 权限被拒绝
- 检查文件权限
- 确认用户权限
- 验证端口是否被占用

## 📞 技术支持

如果遇到问题，请检查：
1. 服务器日志
2. 网络配置
3. 防火墙设置
4. 路由器配置

## 🔗 相关链接

- [Node.js 官方文档](https://nodejs.org/docs/)
- [Express.js 官方文档](https://expressjs.com/)
- [网络安全最佳实践](https://owasp.org/www-project-top-ten/)
- [端口转发配置指南](https://portforward.com/) 